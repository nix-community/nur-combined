From 3281a0a775e1edc09039d97fa6374586d7a8be28 Mon Sep 17 00:00:00 2001
From: Herwig Hochleitner <herwig@bendlas.net>
Date: Sun, 30 Nov 2025 06:52:20 +0100
Subject: [PATCH 2/2] make track loading robust against non-existent tracks

---
 handlers/export.py | 12 ++++++++----
 1 file changed, 8 insertions(+), 4 deletions(-)

diff --git a/handlers/export.py b/handlers/export.py
index b7e4e1f..5981732 100644
--- a/handlers/export.py
+++ b/handlers/export.py
@@ -36,6 +36,9 @@ def get_track_info(
     key_type: KeyType,
     export_semaphore: Semaphore,
 ) -> tuple[TrackContext, BeatGridInfo | None]:
+    info = sql_handlers.get_track_info(track_id)
+    if info is None:
+        return None, None
     (
         samplerate,
         channels,
@@ -51,13 +54,11 @@ def get_track_info(
         rating,
         colour,
         track_location,
-    ) = sql_handlers.get_track_info(track_id)
-
+    ) = info
     if out_dir or out_format:
         track_location = change_track_location(
             track_location, out_dir, out_format, export_semaphore
         )
-
     return TrackContext(
         id=track_id,
         samplerate=int(samplerate),
@@ -105,10 +106,11 @@ def get_exported_track(
 ) -> ExportedTrack:
     if track_id in track_collection:
         return track_collection[track_id]
-
     track_context, beat_grid = get_track_info(
         track_id, out_dir, out_format, key_type, export_semaphore
     )
+    if track_context is None:
+        return None
     return ExportedTrack(
         id=format_track_id(track_id),
         track_context=track_context,
@@ -140,6 +142,7 @@ def get_data_for_tracks(
         initargs=(db_location,),
     ) as pool:
         return list(
+            el for el in
             tqdm(
                 pool.imap(
                     partial(
@@ -156,6 +159,7 @@ def get_data_for_tracks(
                 unit="track",
                 total=len(track_ids),
             )
+            if el is not None
         )
 
 
-- 
2.51.2

