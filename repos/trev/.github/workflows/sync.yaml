name: sync

on:
  schedule:
    - cron: "9 * * * *"
  workflow_dispatch:

permissions:
  contents: read

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Get repos.json
        run: |
          curl -o repos.json "https://raw.githubusercontent.com/nix-community/NUR/refs/heads/main/repos.json.lock"
          echo "REPOS_JSON=$(jq -c . < repos.json)" >> $GITHUB_ENV

      - name: Compare revs
        run: |
          NUR_REV='${{ fromJson(env.REPOS_JSON).repos.trev.rev }}'
          echo "nur rev: ${NUR_REV}"

          GIT_REV=$(git rev-parse HEAD)
          echo "git rev: ${GIT_REV}"

          if [[ "${NUR_REV}" != "${GIT_REV}" ]]; then
            echo "nur rev does not match git rev"
            exit 1
          fi
