#!/usr/bin/env nix-shell
#!nix-shell -i bash -p cabal2nix curl jq nixfmt
#
# This script updates the nix-output-monitor derivation to the latest commit on the
# default branch using cabal2nix.

set -eo pipefail

script_dir="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd )"

derivation_file="${script_dir}/generated-package.nix"
owner="maralorn"
repo="nix-output-monitor"
repo_api="https://code.maralorn.de/api/v1/repos/${owner}/${repo}"

default_branch=$(
  curl --silent "${repo_api}" \
    | jq -r '.default_branch // "main"'
)

latest_commit=$(
  curl --silent "${repo_api}/commits?sha=${default_branch}&limit=1" \
    | jq -r '.[0].sha // .[0].id // .[0].commit.id // empty'
)

if [[ -z "${latest_commit}" || "${latest_commit}" == "null" ]]; then
  echo "Could not determine latest commit for ${owner}/${repo} on ${default_branch}."
  exit 1
fi

archive_url="https://code.maralorn.de/${owner}/${repo}/archive/${latest_commit}.tar.gz"

echo "Updating nix-output-monitor to commit ${latest_commit} on ${default_branch}."
echo "Running cabal2nix and outputting to ${derivation_file}..."

cat > "$derivation_file" << EOF
# This file has been autogenerated with cabal2nix.
# Update via ./update.sh
EOF

cabal2nix \
  --maintainer maralorn \
  "${archive_url}" \
  >> "$derivation_file"

nixfmt "$derivation_file"

echo "Finished."
