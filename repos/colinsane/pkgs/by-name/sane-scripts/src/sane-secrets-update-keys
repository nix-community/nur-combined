#!/usr/bin/env nix-shell
#!nix-shell -i bash -p bash -p coreutils-full -p findutils -p sops

usage() {
  echo "sane-secrets-update-keys DIRECTORY..."
  echo
  echo "after modifying .sops.yaml, run this to re-encode all secrets to the new keys"
  echo "pass the base directory (under which *everything* is a secret) as argument(s)"
}

paths=()
parseArgs() {
  while [ "$#" -ne 0 ]; do
    local arg=$1
    shift
    case $arg in
      (--help)
        usage
        exit 0
        ;;
      (*)
        paths+=("$arg")
        ;;
    esac
  done
}

main() {
  for base in "${paths[@]}"; do
    for i in $(find "$base" -print)
    do
      yes | sops updatekeys "$i"
    done
  done
}

parseArgs "$@"
main
