#!/usr/bin/env nix-shell
#!nix-shell -i bash -p bash -p systemdMinimal

usage() {
  echo "swaync-service-dispatcher <action> <service>"
  echo ""
  echo "actions:"
  echo "- print <service>"
  echo "  prints 'true' or 'false' based on if the service is wanted-up (i.e. started or starting)"
  echo "- up <service>"
  echo "- down <service>"
  echo "- toggle <service>"
}

action=
service=
parseArgs() {
  while [ "$#" -ne 0 ]; do
    local arg=$1
    shift
    case $arg in
      (--help)
        usage
        exit 0
        ;;
      (*)
        if [ -z "$action" ]; then
          action=$arg
        elif [ -z "$service" ]; then
          service=$arg
        else
          usage
          exit 1
        fi
        ;;
    esac
  done

  if [ -z "$action" ] || [ -z "$service" ]; then
    usage
    exit 1
  fi
}

log() {
  if [ -n "$SWAYNC_DEBUG" ]; then
    printf "%s\n" "$1"
  fi
}

checkActive() {
  systemctl is-active "$service" > /dev/null && echo true || echo false
}
startService() {
  log "startService: $service"
  systemctl start "$service"
}
stopService() {
  log "stopService: $service"
  systemctl stop "$service"
}

main() {
  case "$action" in
    (print)
      checkActive
      ;;
    (toggle)
      case "$(checkActive)" in
        false)
          startService
          ;;
        true)
          stopService
          ;;
      esac
      ;;
    # these aren't needed by swaync; just handy for testing/debugging
    (up)
      startService
      ;;
    (down)
      stopService
      ;;
    (*)
      usage
      exit 1
      ;;
  esac
}

parseArgs "$@"
main
