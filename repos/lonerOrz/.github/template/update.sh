#!/usr/bin/env bash
set -euo pipefail

# =============================================================================
# Package metadataï¼ˆå¿…é¡»é…ç½®ï¼‰
# =============================================================================

owner="Fabric-Development"
repo="gray"
pname="fabric-gray"

PKG_FILE="default.nix"
BUILD_TARGET=".#${pname}"

# éœ€è¦æ›´æ–°çš„ hash åˆ—è¡¨ï¼ˆé¡ºåºå³ build é¡ºåºï¼‰
HASH_KEYS=(hash)

DUMMY_HASH="sha256-AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA="

# =============================================================================
# è·¯å¾„
# =============================================================================

script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
package_file="$script_dir/$PKG_FILE"

# =============================================================================
# ï¼ˆå¯é€‰ï¼‰é¢„å¤„ç†é’©å­ï¼ˆå¿…é¡»åœ¨æ›´æ–° rev ä¹‹å‰ï¼‰
# =============================================================================
# è¯­ä¹‰çº¦æŸï¼š
#   - ä»…ç”¨äºä¾èµ–ä¿®è¡¥ / workaround
#   - ä¸å¾—ä¿®æ”¹ä¸» package çš„ rev / version
#   - é»˜è®¤ä»€ä¹ˆéƒ½ä¸åš
# =============================================================================

pre_update_hook() {
  :
}

# =============================================================================
# å›é€€æœºåˆ¶ï¼ˆä»»ä½•å¤±è´¥éƒ½å›æ»šï¼‰
# =============================================================================

backup="$(mktemp)"
cp "$package_file" "$backup"

rollback() {
  echo "âŒ æ›´æ–°å¤±è´¥ï¼Œå›æ»š $PKG_FILE"
  cp "$backup" "$package_file"
}
trap rollback EXIT

# =============================================================================
# 0ï¸âƒ£ æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°ï¼ˆå¿…é¡»æ˜¯ç¬¬ä¸€é˜¶æ®µï¼‰
# =============================================================================

echo "ğŸ” Checking latest upstream revision"

latest_rev="$(
  git ls-remote "https://github.com/$owner/$repo.git" HEAD | cut -f1
)"

if [[ -z "$latest_rev" ]]; then
  echo "âŒ æ— æ³•è·å–è¿œç«¯ä»“åº“ä¿¡æ¯"
  exit 1
fi

current_rev="$(
  grep -oP 'rev\s*=\s*"\K[^"]+' "$package_file" || true
)"

if [[ "$latest_rev" == "$current_rev" ]]; then
  echo "âœ… å·²æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼Œæ— éœ€æ›´æ–°"
  trap - EXIT
  rm -f "$backup"
  exit 0
fi

echo "â¬†ï¸ å‘ç°æ›´æ–°"
echo "  current: $current_rev"
echo "  latest : $latest_rev"

# =============================================================================
# 1ï¸âƒ£ pre_update_hookï¼ˆåœ¨ rev å˜åŒ–ä¹‹å‰ï¼‰
# =============================================================================

pre_update_hook

# =============================================================================
# 2ï¸âƒ£ æ›´æ–° rev
# =============================================================================

sed -i -E \
  "s|(rev\s*=\s*\")[^\"]+(\")|\1$latest_rev\2|" \
  "$package_file"

# =============================================================================
# 3ï¸âƒ£ é€ä¸ª hash è·å–ï¼ˆä¸€ build ä¸€ hashï¼‰
# =============================================================================

for key in "${HASH_KEYS[@]}"; do
  echo "ğŸ§ª Updating hash: $key"

  sed -i -E \
    "s|(${key}[[:space:]]*=[[:space:]]*\")[^\"]+(\".*)|\1${DUMMY_HASH}\2|" \
    "$package_file"

  if nix build "$BUILD_TARGET" 2>build.log; then
    echo "âŒ é¢„æœŸå¤±è´¥ä½†æ„å»ºæˆåŠŸï¼ˆhash æœªç”Ÿæ•ˆï¼‰"
    exit 1
  fi

  new_hash="$(
    grep -oP 'got:\s*\Ksha256-[a-zA-Z0-9+/=]+' build.log | head -n1 || true
  )"

  if [[ -z "$new_hash" ]]; then
    echo "âŒ æœªèƒ½æå– $key"
    tail -n20 build.log
    exit 1
  fi

  echo "âœ” $key = $new_hash"
  sed -i "s|$DUMMY_HASH|$new_hash|" "$package_file"
done

# =============================================================================
# 4ï¸âƒ£ æœ€ç»ˆéªŒè¯
# =============================================================================

echo "ğŸ Final build verification"
nix build "$BUILD_TARGET"

# =============================================================================
# æˆåŠŸ
# =============================================================================

trap - EXIT
rm -f "$backup" build.log

echo "âœ… Update finished successfully"
