name: NUR Sync Check

# 触发条件：master 有新提交或手动触发
on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  check-sync:
    runs-on: ubuntu-latest
    env:
      MY_NUR_REPO: "https://github.com/lonerOrz/loneros-nur.git"
      MAX_ATTEMPTS: 60 # 轮询次数
      SLEEP_SEC: 60 # 每分钟检查一次
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Get latest fork commit
        id: get_commit
        run: |
          MY_REV=$(git ls-remote "$MY_NUR_REPO" HEAD | awk '{print $1}')
          echo "MY_REV=$MY_REV" >> $GITHUB_ENV
          echo "Latest fork commit: $MY_REV"

      - name: Poll official NUR
        run: |
          set -e
          STATUS="unsynced"
          for i in $(seq 1 $MAX_ATTEMPTS); do
            OFFICIAL_LOCK=$(mktemp)
            curl -sL https://raw.githubusercontent.com/nix-community/NUR/main/repos.json.lock -o "$OFFICIAL_LOCK"

            OFFICIAL_REV=$(jq -r --arg url "$MY_NUR_REPO" \
              '.repos.lonerOrz.rev' "$OFFICIAL_LOCK")

            echo "Attempt $i: official rev = $OFFICIAL_REV"

            if [ "$MY_REV" = "$OFFICIAL_REV" ]; then
              STATUS="synced"
              echo "Repository is synced with official NUR"
              break
            fi

            sleep $SLEEP_SEC
          done

          if [ "$STATUS" != "synced" ]; then
            echo "Repository is NOT synced with official NUR after $MAX_ATTEMPTS attempts"
            exit 1
          fi
