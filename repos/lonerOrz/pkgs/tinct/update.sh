#!/usr/bin/env bash
set -euo pipefail

# =============================================================================
# Package metadataï¼ˆå¿…é¡»é…ç½®ï¼‰
# =============================================================================

# https://github.com/lonerOrz/tinct
owner="lonerOrz"
repo="tinct"
pname="tinct"

PKG_FILE="default.nix"
BUILD_TARGET=".#${pname}"

# éœ€è¦æ›´æ–°çš„ hash åˆ—è¡¨ï¼ˆé¡ºåºå³ build é¡ºåºï¼Œå¿…é¡»æ»¡è¶³ä¾èµ–æ‹“æ‰‘ï¼‰
HASH_KEYS=(hash cargoHash)

DUMMY_HASH="sha256-AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA="

# =============================================================================
# è·¯å¾„
# =============================================================================

script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
package_file="$script_dir/$PKG_FILE"

# ä¸´æ—¶å·¥ä½œç›®å½•ï¼ˆä¸æ±¡æŸ“ä»“åº“ï¼‰
workdir="$(mktemp -d)"
build_log="$workdir/build.log"

# =============================================================================
# ï¼ˆå¯é€‰ï¼‰é¢„å¤„ç†é’©å­ï¼ˆå¿…é¡»åœ¨æ›´æ–° rev ä¹‹å‰ï¼‰
# =============================================================================

pre_update_hook() {
  :
}

# =============================================================================
# å›é€€æœºåˆ¶ï¼ˆä»»ä½•å¤±è´¥éƒ½å›æ»šï¼‰
# =============================================================================

backup="$(mktemp)"
cp "$package_file" "$backup"

rollback() {
  echo "âŒ æ›´æ–°å¤±è´¥ï¼Œå›æ»š $PKG_FILE"
  cp "$backup" "$package_file"
}
trap rollback EXIT

# =============================================================================
# 0ï¸âƒ£ æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°ï¼ˆå¿…é¡»æ˜¯ç¬¬ä¸€é˜¶æ®µï¼‰
# =============================================================================

echo "ğŸ” Checking latest upstream revision"

latest_rev="$(
  git ls-remote "https://github.com/$owner/$repo.git" HEAD | cut -f1
)"

if [[ -z "$latest_rev" ]]; then
  echo "âŒ æ— æ³•è·å–è¿œç«¯ä»“åº“ä¿¡æ¯"
  exit 1
fi

current_rev="$(
  grep -oP 'rev\s*=\s*"\K[^"]+' "$package_file" || true
)"

if [[ "$latest_rev" == "$current_rev" ]]; then
  echo "âœ… å·²æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼Œæ— éœ€æ›´æ–°"
  trap - EXIT
  rm -f "$backup"
  rm -rf "$workdir"
  exit 0
fi

echo "â¬†ï¸ å‘ç°æ›´æ–°"
echo "  current: $current_rev"
echo "  latest : $latest_rev"

# =============================================================================
# 1ï¸âƒ£ pre_update_hookï¼ˆåœ¨ rev å˜åŒ–ä¹‹å‰ï¼‰
# =============================================================================

pre_update_hook

# =============================================================================
# 2ï¸âƒ£ æ›´æ–° rev
# =============================================================================

sed -i -E \
  "s|(rev\s*=\s*\")[^\"]*(\")|\1$latest_rev\2|" \
  "$package_file"

# =============================================================================
# 3ï¸âƒ£ é€ä¸ª hash è·å–ï¼ˆé€æ¬¡æ”¶æ•›ï¼Œä¸€ build ä¸€ hashï¼‰
# =============================================================================
# è¯­ä¹‰ä¿è¯ï¼š
#   - æ¯ä¸€è½® build éƒ½è¿è¡Œåœ¨â€œä¹‹å‰ hash å·²ä¿®å¤â€çš„è¡¨è¾¾å¼ä¹‹ä¸Š
#   - æ”¯æŒ hash = "" / hash = "..." ä¸¤ç§çŠ¶æ€
#   - å¯¹ buildRustPackage æ˜¯åˆæ³•ä¸”æ­£ç¡®çš„
# =============================================================================

for key in "${HASH_KEYS[@]}"; do
  echo "ğŸ§ª Updating hash: $key"

  # 1ï¸âƒ£ å†™å…¥ dummyï¼ˆå…è®¸ç©ºå€¼ï¼Œå­—æ®µçº§é”šå®šï¼‰
  sed -i -E \
    "s|(^[[:space:]]*${key}[[:space:]]*=[[:space:]]*\")[^\"]*(\"[[:space:]]*;)|\1${DUMMY_HASH}\2|" \
    "$package_file"

  # 2ï¸âƒ£ è§¦å‘ FOD mismatch
  if nix build "$BUILD_TARGET" 2>"$build_log"; then
    echo "âŒ é¢„æœŸå¤±è´¥ä½†æ„å»ºæˆåŠŸï¼ˆhash æœªç”Ÿæ•ˆï¼‰"
    exit 1
  fi

  # 3ï¸âƒ£ ä» build log æå–çœŸå® hash
  new_hash="$(
    grep -oP 'got:\s*\Ksha256-[A-Za-z0-9+/=]+' "$build_log" | head -n1 || true
  )"

  if [[ -z "$new_hash" ]]; then
    echo "âŒ æœªèƒ½æå– $key"
    tail -n20 "$build_log"
    exit 1
  fi

  echo "âœ” $key = $new_hash"

  # 4ï¸âƒ£ å›å¡«çœŸå® hashï¼ˆåŒæ ·å­—æ®µçº§é”šå®šï¼‰
  sed -i -E \
    "s|(^[[:space:]]*${key}[[:space:]]*=[[:space:]]*\")${DUMMY_HASH}(\"[[:space:]]*;)|\1${new_hash}\2|" \
    "$package_file"
done

# =============================================================================
# 4ï¸âƒ£ æœ€ç»ˆéªŒè¯
# =============================================================================

# echo "ğŸ Final build verification"
# nix build "$BUILD_TARGET"

# =============================================================================
# æˆåŠŸ
# =============================================================================

trap - EXIT
rm -f "$backup"
rm -rf "$workdir"

echo "âœ… Update finished successfully"
