From e91220d035283b8b291a23cf11f2c2e7b0b767b1 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Gutyina=20Gerg=C5=91?= <gutyina.gergo.2@gmail.com>
Date: Tue, 30 Dec 2025 22:31:27 +0100
Subject: [PATCH] Drop usage of unstable if_let_guard feature

---
 src/gui/message.rs | 86 +++++++++++++++++++++++++++-------------------
 src/lib.rs         | 34 ++++++++++--------
 2 files changed, 70 insertions(+), 50 deletions(-)

diff --git a/src/gui/message.rs b/src/gui/message.rs
index d18acb7..33be703 100644
--- a/src/gui/message.rs
+++ b/src/gui/message.rs
@@ -214,19 +214,25 @@ impl Integrate {
                     info!("integration complete");
                     app.last_action = Some(LastAction::success("integration complete".to_string()));
                 }
-                Err(ref e)
-                    if let IntegrationError::ProviderError { source } = e
-                        && let ProviderError::NoProvider { url: _, factory } = source =>
-                {
-                    app.window_provider_parameters =
-                        Some(WindowProviderParameters::new(factory, &app.state));
-                    app.last_action = Some(LastAction::failure("no provider".to_string()));
-                }
-                Err(e) => {
-                    error!("{}", e);
-                    app.problematic_mod_id = e.opt_mod_id();
-                    app.last_action = Some(LastAction::failure(e.to_string()));
-                }
+                Err(ref e) => match e {
+                    IntegrationError::ProviderError { source } => match source {
+                        ProviderError::NoProvider { url: _, factory } => {
+                            app.window_provider_parameters =
+                                Some(WindowProviderParameters::new(factory, &app.state));
+                            app.last_action = Some(LastAction::failure("no provider".to_string()));
+                        }
+                        _ => {
+                            error!("{}", e);
+                            app.problematic_mod_id = e.opt_mod_id();
+                            app.last_action = Some(LastAction::failure(e.to_string()));
+                        }
+                    },
+                    _ => {
+                        error!("{}", e);
+                        app.problematic_mod_id = e.opt_mod_id();
+                        app.last_action = Some(LastAction::failure(e.to_string()));
+                    }
+                },
             }
             app.integrate_rid = None;
         }
@@ -284,16 +290,18 @@ impl UpdateCache {
                         "successfully updated cache".to_string(),
                     ));
                 }
-                Err(ProviderError::NoProvider { url: _, factory }) => {
-                    app.window_provider_parameters =
-                        Some(WindowProviderParameters::new(factory, &app.state));
-                    app.last_action = Some(LastAction::failure("no provider".to_string()));
-                }
-                Err(e) => {
-                    error!("{}", e);
-                    app.problematic_mod_id = e.opt_mod_id();
-                    app.last_action = Some(LastAction::failure(e.to_string()));
-                }
+                Err(ref e) => match e {
+                    ProviderError::NoProvider { url: _, factory } => {
+                        app.window_provider_parameters =
+                            Some(WindowProviderParameters::new(factory, &app.state));
+                        app.last_action = Some(LastAction::failure("no provider".to_string()));
+                    }
+                    _ => {
+                        error!("{}", e);
+                        app.problematic_mod_id = e.opt_mod_id();
+                        app.last_action = Some(LastAction::failure(e.to_string()));
+                    }
+                },
             }
             app.update_rid = None;
         }
@@ -475,19 +483,25 @@ impl LintMods {
                     app.last_action =
                         Some(LastAction::success("lint mod report complete".to_string()));
                 }
-                Err(ref e)
-                    if let IntegrationError::ProviderError { source } = e
-                        && let ProviderError::NoProvider { url: _, factory } = source =>
-                {
-                    app.window_provider_parameters =
-                        Some(WindowProviderParameters::new(factory, &app.state));
-                    app.last_action = Some(LastAction::failure("no provider".to_string()));
-                }
-                Err(e) => {
-                    error!("{}", e);
-                    app.problematic_mod_id = e.opt_mod_id();
-                    app.last_action = Some(LastAction::failure(e.to_string()));
-                }
+                Err(ref e) => match e {
+                    IntegrationError::ProviderError { source } => match source {
+                        ProviderError::NoProvider { url: _, factory } => {
+                            app.window_provider_parameters =
+                                Some(WindowProviderParameters::new(factory, &app.state));
+                            app.last_action = Some(LastAction::failure("no provider".to_string()));
+                        }
+                        _ => {
+                            error!("{}", e);
+                            app.problematic_mod_id = e.opt_mod_id();
+                            app.last_action = Some(LastAction::failure(e.to_string()));
+                        }
+                    },
+                    _ => {
+                        error!("{}", e);
+                        app.problematic_mod_id = e.opt_mod_id();
+                        app.last_action = Some(LastAction::failure(e.to_string()));
+                    }
+                },
             }
             app.integrate_rid = None;
         }
diff --git a/src/lib.rs b/src/lib.rs
index 506e4b3..21fc149 100644
--- a/src/lib.rs
+++ b/src/lib.rs
@@ -1,4 +1,5 @@
-#![feature(if_let_guard)]
+// TODO: enable when stabilized: https://github.com/rust-lang/rust/issues/51114
+//#![feature(if_let_guard)]
 
 pub mod gui;
 pub mod integrate;
@@ -211,13 +212,15 @@ where
     loop {
         match resolve_unordered_and_integrate(&game_path, state, mod_specs, update).await {
             Ok(()) => return Ok(()),
-            Err(ref e)
-                if let IntegrationError::ProviderError { source } = e
-                    && let ProviderError::NoProvider { url, factory } = source =>
-            {
-                init(state, url.clone(), factory)?
+            Err(e) => {
+                if let IntegrationError::ProviderError { source } = &e {
+                    if let ProviderError::NoProvider { url, factory } = source {
+                        init(state, url.clone(), factory)?;
+                        continue;
+                    }
+                }
+                Err(e)?;
             }
-            Err(e) => Err(e)?,
         }
     }
 }
@@ -234,14 +237,17 @@ where
     loop {
         match resolve_ordered(state, mod_specs).await {
             Ok(mod_paths) => return Ok(mod_paths),
-            Err(ref e)
-                if let MintError::IntegrationError { source } = e
-                    && let IntegrationError::ProviderError { source } = source
-                    && let ProviderError::NoProvider { url, factory } = source =>
-            {
-                init(state, url.clone(), factory)?
+            Err(e) => {
+                if let MintError::IntegrationError { source } = &e {
+                    if let IntegrationError::ProviderError { source } = source {
+                        if let ProviderError::NoProvider { url, factory } = source {
+                            init(state, url.clone(), factory)?;
+                            continue;
+                        }
+                    }
+                }
+                Err(e)?;
             }
-            Err(e) => Err(e)?,
         }
     }
 }
-- 
2.51.2

