name: PR Merged Cleanup

on:
  pull_request_target:
    types: [closed]

jobs:
  cleanup-merged-pr:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          token: ${{ secrets.AUTOMERGE_TOKEN }}

      - name: Delete merged branch
        run: |
          # 获取PR信息
          PR_NUMBER="${{ github.event.pull_request.number }}"
          BRANCH_NAME="${{ github.event.pull_request.head.ref }}"
          REPO="${{ github.repository }}"

          echo "处理合并的PR #$PR_NUMBER"
          echo "分支名: $BRANCH_NAME"

          # 检查分支名是否符合自动生成的模式
          if [[ "$BRANCH_NAME" =~ ^auto-update- ]] || [[ "$BRANCH_NAME" =~ ^update/ ]]; then
            echo "检测到自动生成的更新分支: $BRANCH_NAME"

            # 检查分支是否存在
            if git ls-remote --heads origin "$BRANCH_NAME" | grep -q "$BRANCH_NAME"; then
              echo "删除分支: $BRANCH_NAME"

              # 使用GitHub CLI删除分支
              gh api \
                --method DELETE \
                "repos/$REPO/git/refs/heads/$BRANCH_NAME" \
                -H "Accept: application/vnd.github.v3+json" \
                || echo "分支 $BRANCH_NAME 可能已被删除或不存在"

              echo "✅ 分支 $BRANCH_NAME 删除完成"
            else
              echo "分支 $BRANCH_NAME 不存在，可能已被删除"
            fi
          else
            echo "分支 $BRANCH_NAME 不是自动生成的更新分支，跳过删除"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.AUTOMERGE_TOKEN }}
