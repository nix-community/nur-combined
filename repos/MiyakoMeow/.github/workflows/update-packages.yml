name: Update Packages via "updateScript"
on:
  schedule:
    - cron: "0 12 * * *" # 每天 UTC 中午12点运行
  workflow_dispatch: # 允许手动触发

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      package_list: ${{ steps.package-list.outputs.package_list }}
      package_count: ${{ steps.package-list.outputs.package_count }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Setup Nix
        uses: cachix/install-nix-action@v31
        with:
          nix_path: nixpkgs=channel:nixpkgs-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes
            substituters = https://miyakomeow.cachix.org/ https://nix-community.cachix.org/ https://cache.nixos.org/
            trusted-public-keys = miyakomeow.cachix.org-1:85k7pjjK1Voo+kMHJx8w3nT1rlBow3+4/M+LsAuMCRY= nix-community.cachix.org-1:mB9FSh9qf2dCimDSUo8Zy7bkq5CX+/rkCWyvRCYg3Fs= cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY=

      - name: Install dependencies
        run: |
          # 安装必要工具
          nix profile install nixpkgs#curl nixpkgs#jq nixpkgs#python3 nixpkgs#nix-update

      - name: Find packages with updateScript
        id: package-list
        shell: bash
        run: |
          bash scripts/update-packages/find-packages-with-update-script.sh

  update-package:
    needs: prepare
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        package: ${{ fromJson(needs.prepare.outputs.package_list) }}
    outputs:
      pr_data: ${{ steps.create-pull-request.outputs.pr_data }}
      has_update: ${{ steps.update.outputs.has_update }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Setup Nix
        uses: cachix/install-nix-action@v31
        with:
          nix_path: nixpkgs=channel:nixpkgs-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes
            substituters = https://miyakomeow.cachix.org/ https://nix-community.cachix.org/ https://cache.nixos.org/
            trusted-public-keys = miyakomeow.cachix.org-1:85k7pjjK1Voo+kMHJx8w3nT1rlBow3+4/M+LsAuMCRY= nix-community.cachix.org-1:mB9FSh9qf2dCimDSUo8Zy7bkq5CX+/rkCWyvRCYg3Fs= cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY=

      - name: Install required tools
        run: |
          # 安装通用工具（包括git用于提交）
          nix profile install nixpkgs#git nixpkgs#python313 nixpkgs#python313Packages.requests nixpkgs#python313Packages.beautifulsoup4 nixpkgs#nix-update nixpkgs#bash nixpkgs#gh

      - name: Update package
        id: update
        shell: bash
        run: |
          bash scripts/update-packages/execute-update-script.sh "${{ matrix.package }}"

      - name: Generate branch name
        id: gen-branch-name
        shell: bash
        run: |
          # Helper: 向 GitHub Actions 的 $GITHUB_OUTPUT 追加输出（本地调试时退回到 stdout）
          append_github_output() {
            # $1 = key, $2 = value
            if [ -n "${GITHUB_OUTPUT:-}" ]; then
              printf '%s=%s\n' "$1" "$2" >> "$GITHUB_OUTPUT"
            else
              printf '%s=%s\n' "$1" "$2"
            fi
          }
          # 创建唯一分支名（可根据 group 优化命名，但此处保持兼容）
          timestamp=$(date +%s)
          branch_name="update/${{ matrix.package }}-$timestamp-$GITHUB_RUN_ID"
          append_github_output "branch_name" "$branch_name"
          echo "分支名称: $branch_name"

      - name: Generate GitHub App Token
        id: gen-token
        uses: tibdex/github-app-token@v2
        with:
          app_id: ${{ secrets.HELPER_BOT_APP_ID }}
          private_key: ${{ secrets.HELPER_BOT_PRIVATE_KEY }}

      - name: Create Pull Request
        if: steps.update.outputs.has_update == 'true'
        id: create-pull-request
        uses: peter-evans/create-pull-request@v7
        with:
          branch: ${{ steps.gen-branch-name.outputs.branch_name }}
          commit-message: "${{ matrix.package }}: auto-update by updateScript"
          title: "${{ matrix.package }}: auto-update by updateScript"
          body: |
            由GitHub Actions自动更新包 ${{ matrix.package }}

            此更新由包的updateScript自动生成
          labels: automated, dependencies
          token: ${{ steps.gen-token.outputs.token }}

      - name: Wait for CI completion
        if: steps.create-pull-request.outputs.pull-request-operation == 'created'
        run: |
          PR_NUMBER='${{ steps.create-pull-request.outputs.pull-request-number }}'
          PACKAGE='${{ matrix.package }}'
          scripts/actions/wait-for-actions.sh "$PR_NUMBER" "$PACKAGE"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Enable Pull Request Automerge
        if: steps.create-pull-request.outputs.pull-request-operation == 'created'
        run: |
          PR_NUMBER='${{ steps.create-pull-request.outputs.pull-request-number }}'
          PACKAGE='${{ matrix.package }}'
          echo "启用PR #$PR_NUMBER ($PACKAGE) 的自动合并"
          gh pr merge "$PR_NUMBER" --auto --squash
        env:
          GITHUB_TOKEN: ${{ steps.gen-token.outputs.token }}
