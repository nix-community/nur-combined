import{cI as k,cK as G,aj as _,aa as e,dU as F,bL as E,bQ as h,dC as M,jY as I,dF as g,dG as p,ab as w,du as v,r as K,jZ as A,j_ as P,cw as T,cx as V,aJ as Q}from"./index-DV5vAjQm.js";import{u as N}from"./useMountEffect-CPPlFtO6.js";import{F as B}from"./FeatureFlag-CkWkBsnO.js";import{D as q}from"./DeleteConfirmationDialog-D1N1r2Jm.js";import{S as J}from"./SourceKindsCheckboxes-q4l60W6G.js";const L={deleteAllAssetGroupSelectors:!1,deleteCollectedGraphData:!1,deleteCustomHighValueSelectors:!1,deleteDataQualityHistory:!1,deleteFileIngestHistory:!1,deleteSourceKinds:[],noSelectionError:!1,mutationError:!1,showSuccessMessage:!1,openDialog:!1},O=(t,s)=>{switch(s.type){case"no_selection_error":return{...t,noSelectionError:!0,mutationError:!1};case"mutation_error":return{...t,mutationError:!0,noSelectionError:!1,mutationErrorMessage:s.message};case"mutation_success":return{...t,deleteAllAssetGroupSelectors:!1,deleteCollectedGraphData:!1,deleteCustomHighValueSelectors:!1,deleteDataQualityHistory:!1,deleteFileIngestHistory:!1,deleteSourceKinds:[],showSuccessMessage:!0};case"selection":{const{targetName:a,checked:c}=s;return{...t,[a]:c,noSelectionError:!1}}case"source_kinds":{const{checked:a}=s;return{...t,deleteSourceKinds:a,noSelectionError:!1}}case"open_dialog":return[t.deleteAllAssetGroupSelectors,t.deleteCollectedGraphData,t.deleteCustomHighValueSelectors,t.deleteDataQualityHistory,t.deleteFileIngestHistory].filter(Boolean).length===0&&t.deleteSourceKinds.length===0?{...t,noSelectionError:!0}:{...t,noSelectionError:!1,openDialog:!0};case"close_dialog":return{...t,openDialog:!1};default:return t}},R=()=>{const[t,s]=K.useReducer(O,L),a=A(P),c=A(T),{deleteAllAssetGroupSelectors:l,deleteCollectedGraphData:f,deleteCustomHighValueSelectors:y,deleteDataQualityHistory:u,deleteFileIngestHistory:b,deleteSourceKinds:S}=t,x=V({mutationFn:async({deleteThisData:o})=>Q.clearDatabase({...o}),onError:o=>{var d,r,i,n,m,j,C;if(((d=o==null?void 0:o.response)==null?void 0:d.status)===500&&((n=(i=(r=o==null?void 0:o.response)==null?void 0:r.data)==null?void 0:i.errors)==null?void 0:n.length)>0){const H=(C=(j=(m=o==null?void 0:o.response)==null?void 0:m.data)==null?void 0:j.errors)==null?void 0:C[0].message;s({type:"mutation_error",message:H})}else s({type:"mutation_error"})},onSuccess:()=>{s({type:"mutation_success"})}});return{handleMutation:()=>{const o=[];l?o.push(...a):y&&o.push(c);const r=(i=>i.filter((n,m)=>i.indexOf(n)===m))(o);x.mutate({deleteThisData:{deleteAssetGroupSelectors:r,deleteCollectedGraphData:f,deleteDataQualityHistory:u,deleteFileIngestHistory:b,deleteSourceKinds:S}})},state:t,dispatch:s}},X=()=>{const{handleMutation:t,state:s,dispatch:a}=R(),{checkPermission:c}=k(),l=c(G.WIPE_DB),{addNotification:f,dismissNotification:y}=_(),u="database-management-permission";N(()=>(l||f("Your user role does not allow managing the database. Please contact your administrator for details.",u,{persist:!0,anchorOrigin:{vertical:"top",horizontal:"right"}}),()=>y(u)));const{deleteAllAssetGroupSelectors:S,deleteCustomHighValueSelectors:x,deleteDataQualityHistory:D,deleteFileIngestHistory:o,deleteSourceKinds:d}=s,r=n=>{a({type:"selection",targetName:n.target.name,checked:n.target.checked})},i=n=>{a({type:"source_kinds",checked:n})};return e.jsxs(F,{title:"Database Management","data-testid":"database-management",pageDescription:e.jsx(v,{variant:"body2",paragraph:!0,children:"Manage your BloodHound data. Select from the options below which data should be deleted."}),children:[e.jsxs(E,{children:[e.jsxs(h,{severity:"warning",sx:{mt:"1rem"},children:[e.jsx("strong",{children:"Caution: "})," This change is irreversible and will delete data from your environment."]}),e.jsxs(E,{display:"flex",flexDirection:"column",alignItems:"start",children:[e.jsxs(M,{variant:"standard",sx:{paddingBlock:2},error:s.noSelectionError||s.mutationError,children:[s.noSelectionError?e.jsx(h,{severity:"error",children:"Please make a selection."}):null,s.mutationError?e.jsx(h,{severity:"error",children:s.mutationErrorMessage?s.mutationErrorMessage:"There was an error processing your request."}):null,s.showSuccessMessage?e.jsx(h,{severity:"info",children:"Deletion of the data is under way. Depending on data volume, this may take some time to complete."}):null,e.jsxs(I,{sx:{paddingTop:1},children:[e.jsx(B,{flagKey:"clear_graph_data",enabled:e.jsx(J,{checked:d,disabled:!l,onChange:i})}),e.jsx(g,{label:"Custom High Value selectors",control:e.jsx(p,{checked:x,onChange:r,name:"deleteCustomHighValueSelectors",disabled:!l})}),e.jsx(g,{label:"All asset group selectors",control:e.jsx(p,{checked:S,onChange:r,name:"deleteAllAssetGroupSelectors",disabled:!l})}),e.jsx(g,{label:"File ingest log history",control:e.jsx(p,{checked:o,onChange:r,name:"deleteFileIngestHistory",disabled:!l})}),e.jsx(g,{label:"Data quality history",control:e.jsx(p,{checked:D,onChange:r,name:"deleteDataQualityHistory",disabled:!l})})]})]}),e.jsx(w,{disabled:!l,onClick:()=>a({type:"open_dialog"}),children:"Delete"})]})]}),e.jsx(q,{open:s.openDialog,onCancel:()=>{a({type:"close_dialog"})},onConfirm:()=>{a({type:"close_dialog"}),t()},itemName:"data from the current environment",itemType:"environment data"})]})};export{X as default};
